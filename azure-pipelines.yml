jobs:
  - job: Rustfmt
    strategy:
        matrix:
            Linux:
                imageName: ubuntu-latest
            macOS:
                imageName: macOS-latest
            Windows:
                imageName: windows-latest
    pool:
        vmImage: $(imageName)
    steps:
      - template: .azure-pipelines/install-rust.yml
      - script: rustup component add rustfmt
        displayName: Install Rustfmt
      - script: cargo fmt -- --check
        displayName: Run Rustfmt checks
  - job: Clippy
    strategy:
        matrix:
            Linux:
                imageName: ubuntu-latest
            macOS:
                imageName: macOS-latest
            Windows:
                imageName: windows-latest
    pool:
        vmImage: $(imageName)
    steps:
      - template: .azure-pipelines/install-rust.yml
      - script: rustup component add clippy
        displayName: Install Clippy
      - script: cargo clippy --all-targets --all-features -- -D warnings
        displayName: Run Clippy checks
  - job: Tests
    strategy:
        matrix:
            Linux:
                imageName: ubuntu-latest
            macOS:
                imageName: macOS-latest
            Windows:
                imageName: windows-latest
    pool:
        vmImage: $(imageName)
    steps:
      - template: .azure-pipelines/install-rust.yml
      - script: cargo test
        displayName: Run tests
  - job: Coverage
    pool:
        vmImage: ubuntu-latest
    steps:
      - template: .azure-pipelines/install-rust.yml
      - script: |
            set -e
            set -o pipefail
            KCOV_VERSION=758f36568abdd19325ba2f7271b28febcb3666a0
            sudo apt-get install --no-install-recommends -y binutils-dev libcurl4-gnutls-dev libdw-dev libiberty-dev
            mkdir kcov
            cd kcov
            curl -L "https://github.com/SimonKagstrom/kcov/archive/$KCOV_VERSION.tar.gz" | tar xz --strip-components 1
            mkdir build
            cd build
            cmake -DCMAKE_BUILD_TYPE=Release ..
            make -j
            sudo make -j install
        displayName: Install Kcov
      - script: cargo install cargo-kcov
        displayName: Install cargo-kcov
      - script: cargo generate-lockfile && cargo kcov -- --exclude-pattern=/.cargo --verify
        displayName: Run coverage tests
      - task: PublishCodeCoverageResults@1
        displayName: Publish coverage result
        inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: target/cov/kcov-merged/cobertura.xml
